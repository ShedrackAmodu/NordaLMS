{% extends 'base.html' %}
{% load i18n %}
{% block title %} {% trans 'Dashboard' %} | {% trans 'Learning management system' %} {% endblock title %}
{% load static %}

{% block header %}
{% endblock %}

{% block content %}

<nav style="--bs-breadcrumb-divider: '>';" aria-label="breadcrumb">
    <ol class="breadcrumb">
      <li class="breadcrumb-item"><a href="/">{% trans 'Home' %}</a></li>
      <li class="breadcrumb-item active" aria-current="page">{% trans 'Dashboard' %}</li>
    </ol>
</nav>

{% include 'snippets/messages.html' %}

<div class="d-flex justify-content-between align-items-center mb-4">
	<h1 class="title-1">{% trans 'Dashboard' %}</h1>
	<div class="dropdown">
		<button type="button" class="btn btn-light dropdown-toggle" data-bs-toggle="dropdown"
			aria-expanded="false">
			<i class="fas fa-cog"></i>
		</button>
		<div class="dropdown-menu">
			<h6 class="dropdown-header">{% trans 'Dashboard settings' %}</h6>
			<button class="dropdown-item active" type="button">{% trans 'Display grid' %}</button>
			<button class="dropdown-item" type="button">{% trans 'Display table' %}</button>
			<hr>
			<button class="dropdown-item" type="button">{% trans 'Manage dashboard' %}</button>
		</div>
	</div>
</div>

<div class="row users-count px-3">
	<div class="col-6 col-md-3 mb-4 px-2">
		<div class="card border-0 shadow-sm p-4 rounded-3 bg-white">
			<div class="d-flex align-items-center">
				<div class="flex-shrink-0">
					<div class="bg-primary bg-opacity-10 rounded-circle p-3">
						<i class="fas fa-users text-primary fa-2x"></i>
					</div>
				</div>
				<div class="flex-grow-1 text-end">
					<h6 class="mb-1 text-muted">{% trans 'Students' %}</h6>
					<h3 class="mb-0 fw-bold">{{ student_count }}</h3>
				</div>
			</div>
		</div>
	</div>
	<div class="col-6 col-md-3 mb-4 px-2">
		<div class="card border-0 shadow-sm p-4 rounded-3 bg-white">
			<div class="d-flex align-items-center">
				<div class="flex-shrink-0">
					<div class="bg-warning bg-opacity-10 rounded-circle p-3">
						<i class="fas fa-chalkboard-teacher text-warning fa-2x"></i>
					</div>
				</div>
				<div class="flex-grow-1 text-end">
					<h6 class="mb-1 text-muted">{% trans 'Lecturers' %}</h6>
					<h3 class="mb-0 fw-bold">{{ lecturer_count }}</h3>
				</div>
			</div>
		</div>
	</div>
	<div class="col-6 col-md-3 mb-3 px-2">
		<div class="card-count p-3">
			<h3><i class="fas fa-users bg-light-red"></i></h3>
			<div class="text-right">
				{% trans 'Administrators' %}
				<h2>{{ superuser_count }}</h2>
			</div>
		</div>
	</div>
	<div class="col-6 col-md-3 mb-3 px-2">
		<div class="card-count p-3">
			<h3><i class="fas fa-users bg-light-purple"></i></h3>
			<div class="text-right">
				{% trans 'Lab Assistance' %}
				<h2>5</h2>
			</div>
		</div>
	</div>
	<div class="col-6 col-md-3 mb-3 px-2">
		<div class="card-count p-3">
			<h3><i class="fas fa-users bg-light-red"></i></h3>
			<div class="text-right">
				{% trans 'Librarians' %}
				<h2>12</h2>
			</div>
		</div>
	</div>
	<div class="col-6 col-md-3 mb-3 px-2">
		<div class="card-count p-3">
			<h3><i class="fas fa-chart-line bg-light-purple"></i></h3>
			<div class="text-right">
				{% trans 'Avg Attendance' %}
				<h2>{{ attendance_avg }}%</h2>
			</div>
		</div>
	</div>
	<div class="col-6 col-md-3 mb-3 px-2">
		<div class="card-count p-3">
			<h3><i class="fas fa-video bg-light-orange"></i></h3>
			<div class="text-right">
				{% trans 'Videos' %}
				<h2>{{ total_videos }}</h2>
			</div>
		</div>
	</div>
	<div class="col-6 col-md-3 mb-3 px-2">
		<div class="card-count p-3">
			<h3><i class="fas fa-file bg-light-aqua"></i></h3>
			<div class="text-right">
				{% trans 'Documents' %}
				<h2>{{ total_docs }}</h2>
			</div>
		</div>
	</div>
	<div class="col-6 col-md-3 mb-3 px-2">
		<div class="card-count p-3">
			<h3><i class="fas fa-book bg-light-red"></i></h3>
			<div class="text-right">
				{% trans 'Courses' %}
				<h2>{{ total_courses }}</h2>
			</div>
		</div>
	</div>
</div>

<div class="row px-2">
	<div class="col-md-6 p-2">
		<div class="chart-wrap">
			<i class="fas fa-expand-alt"></i>
			<canvas id="traffic"></canvas>
		</div>
	</div>
	<div class="col-md-6 p-2">
		<div class="chart-wrap">
			<i class="fas fa-expand-alt"></i>
			<canvas id="enrollement"></canvas>
		</div>
	</div>
	<div class="col-md-6 p-2">
		<div class="chart-wrap">
			<i class="fas fa-expand-alt"></i>
			<canvas id="students_grade"></canvas>
		</div>
	</div>
	<div class="col-md-6 p-2">
		<div class="card w-100 h-100 p-3">
			<h5>{% trans 'Latest activities' %}</h5>
			<ul class="ps-2 small">
				{% for log in logs %}
				<li>{{ log.message }} <span class="text-muted">- {{ log.created_at }}</span></li>
				{% empty %}
				<li>{% trans 'No recent activity' %}</li>
				{% endfor %}
			</ul>
		</div>
	</div>
</div>
<br>
<div class="bg-white p-3">
	<h5 class="border-bottom pb-2">{% trans 'School Demographics' %}</h5>
	<div class="row">
		<div class="col-md-4">
			<i class="fas fa-expand-alt"></i>
			<canvas id="gender"></canvas>
		</div>
		<div class="col-md-4">
			<i class="fas fa-expand-alt"></i>
			<canvas id="ethnicity"></canvas>
		</div>
		<div class="col-md-4">
			<i class="fas fa-expand-alt"></i>
			<canvas id="language"></canvas>
		</div>
	</div>
</div>

<div class="bg-white p-3 mt-3">
	<h5 class="border-bottom pb-2">{% trans 'Upcoming Events' %}</h5>
	<ul class="list-group">
		{% for event in upcoming_events %}
		<li class="list-group-item d-flex justify-content-between">
			<div>{{ event.title }}</div>
			<div class="text-muted">{{ event.event_date }}</div>
		</li>
		{% empty %}
		<li class="list-group-item text-muted">No upcoming events</li>
		{% endfor %}
	</ul>
</div>

{% endblock content %}

{% block js %}

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
function gettext(str) { return str; }
</script>
<script src="{% static 'js/dashboard.js' %}"></script>
<script>
	$('.fa-expand-alt').click(function () {
		if ($(this).parent('.chart-wrap').parent('.col-md-6').hasClass('expand')) {
			$('.col-md-6.expand').removeClass('expand');
		}
		else {
			$('.col-md-6.expand')?.removeClass('expand');
			$(this).parent('.chart-wrap').parent('.col-md-6').addClass('expand');
		}
	})
</script>
<script>
const malesCount = {{ males_count }}
const femalesCount = {{ females_count }}
const student_levels = {{ student_levels|safe }}
const course_grades = {{ course_grades|safe }}
const enrollments_per_course = {{ enrollments_per_course|safe }}
const traffic_labels = {{ traffic_labels|safe }}
const traffic_counts = {{ traffic_counts|safe }}

$(document).ready(function () {
    // Traffic Chart
    const trafficData = {
        labels: traffic_labels,
        datasets: [{
            label: gettext('Activity Count'),
            backgroundColor: 'rgba(86, 224, 224, 0.5)',
            borderColor: 'rgb(86, 224, 224)',
            hoverBorderWidth: 3,
            data: traffic_counts
        }]
    };
    var trafficCanvas = document.getElementById('traffic');
    new Chart(trafficCanvas, {
        type: 'line',
        data: trafficData,
        options: {
            plugins: {
                title: {
                    display: true,
                    text: gettext('Website Traffic (Activity)'),
                    padding: 15
                }
            }
        }
    });

    // Enrollment Chart
    const enrollmentLabels = enrollments_per_course.map(item => item.course_title);
    const enrollmentData = enrollments_per_course.map(item => item.enrollments);
    const dataEnrollment = {
        labels: enrollmentLabels,
        datasets: [{
            label: gettext('Enrollments'),
            backgroundColor: 'rgba(86, 224, 224, 0.5)',
            borderColor: 'rgb(86, 224, 224)',
            hoverBorderWidth: 3,
            data: enrollmentData
        }]
    };
    var enrollmentCanvas = document.getElementById('enrollement');
    new Chart(enrollmentCanvas, {
        type: 'bar',
        data: dataEnrollment,
        options: {
            plugins: {
                title: {
                    display: true,
                    text: gettext('Enrollment per course'),
                    padding: 20
                }
            }
        }
    });

    // Grades Chart
    const gradeLabels = course_grades.map(item => item.course_title);
    const gradeData = course_grades.map(item => item.avg_grade);
    const dataGrade = {
        labels: gradeLabels,
        datasets: [{
            label: gettext("Average Grade"),
            backgroundColor: 'rgba(86, 224, 224, 0.5)',
            borderColor: 'rgb(86, 224, 224)',
            hoverBorderWidth: 3,
            data: gradeData
        }]
    };
    var gradeCanvas = document.getElementById('students_grade');
    new Chart(gradeCanvas, {
        type: 'bar',
        data: dataGrade,
        options: {
            plugins: {
                title: {
                    display: true,
                    text: gettext('Students average grade (performance)'),
                    padding: 20
                }
            }
        }
    });

    // Gender Chart
    const dataGender = {
        labels: [gettext('Man'), gettext('Women')],
        datasets: [{
            label: gettext("Students Gender Dataset"),
            data: [malesCount, femalesCount],
            backgroundColor: ['rgb(255, 99, 132)', 'rgb(54, 162, 235)'],
            hoverOffset: 4
        }]
    };
    var genderCanvas = document.getElementById('gender');
    new Chart(genderCanvas, {
        type: 'pie',
        data: dataGender,
        options: {
            plugins: {
                title: {
                    display: true,
                    text: gettext('Students Gender'),
                    padding: 20
                }
            }
        }
    });

    // Qualification Chart (static)
    const dataQualification = {
        labels: [gettext('PHD'), gettext('Masters'), gettext('BSc degree')],
        datasets: [{
            label: gettext("Lecturer Qualifications Dataset"),
            data: [24, 30, 26],
            backgroundColor: ['rgb(255, 99, 132)', 'rgb(255, 193, 7)', 'rgb(54, 162, 235)'],
            hoverOffset: 4
        }]
    };
    var qualCanvas = document.getElementById('ethnicity');
    new Chart(qualCanvas, {
        type: 'pie',
        data: dataQualification,
        options: {
            plugins: {
                title: {
                    display: true,
                    text: gettext('Lecturer qualifications'),
                    padding: 20
                }
            }
        }
    });

    // Levels Chart
    const levelLabels = student_levels.map(item => item.level);
    const levelData = student_levels.map(item => item.count);
    const dataLevels = {
        labels: levelLabels,
        datasets: [{
            label: gettext("Students level"),
            data: levelData,
            backgroundColor: ['rgb(255, 99, 132)', 'rgb(255, 193, 7)', 'rgb(54, 162, 235)'],
            hoverOffset: 4
        }]
    };
    var levelCanvas = document.getElementById('language');
    new Chart(levelCanvas, {
        type: 'pie',
        data: dataLevels,
        options: {
            plugins: {
                title: {
                    display: true,
                    text: gettext('Student levels'),
                    padding: 20
                }
            }
        }
    });
});
</script>

{% endblock %}
